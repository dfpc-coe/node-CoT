import test from 'tape';
import { CoTParser } from '../index.js';

test('normalize_geojson - Point', async (t) => {
    const feat = await CoTParser.normalize_geojson({
        id: "3dcbbdf0-b832-4f86-ac8b-d33f64acfad5",
        type: "Feature",
        properties:{
            "-updated-by":"16SV07",
            "creator":"16SV07",
            "-created-on":1752439330699,
            "-updated-on":1752439330699,
            "description":"",
            "title": "",
            "marker-size":"1",
            "marker-rotation":null,
            "marker-symbol":"c:target2",
            "marker-color":"FF0000",
            "class":"Marker",
            "updated":1752439330699,
            "-created-by":"16SV07"
        },
        geometry: {"coordinates":[-108.2982,39.0833,0,0],"type":"Point"},
    });

    t.ok(feat.properties.start);
    feat.properties.start = '2025-07-14T03:00:57.112Z';
    t.ok(feat.properties.time);
    feat.properties.time = '2025-07-14T03:00:57.112Z';
    t.ok(feat.properties.stale);
    feat.properties.stale = '2025-07-14T03:00:57.112Z';

    t.deepEquals(feat, {
        id: '3dcbbdf0-b832-4f86-ac8b-d33f64acfad5',
        type: 'Feature',
        properties: {
            type: 'u-d-p',
            archived: true,
            callsign: 'New Feature',
            remarks: '',
            'marker-color': '#FF0000',
            time: '2025-07-14T03:00:57.112Z',
            start: '2025-07-14T03:00:57.112Z',
            stale: '2025-07-14T03:00:57.112Z',
            center: [
                -108.2982,
                39.0833
            ],
            metadata: {
                "-updated-by":"16SV07",
                "creator":"16SV07",
                "-created-on":1752439330699,
                "-updated-on":1752439330699,
                "description":"",
                "title": "",
                "marker-size":"1",
                "marker-rotation":null,
                "marker-symbol":"c:target2",
                "marker-color":"FF0000",
                "class":"Marker",
                "updated":1752439330699,
                "-created-by":"16SV07"
            }
        },
        geometry: {
            type: 'Point',
            coordinates: [ -108.2982, 39.0833, 0, 0 ],
        }
    });

    t.end();
});

test('normalize_geojson - LineString', async (t) => {
    const feat = await CoTParser.normalize_geojson({
        id:"d9e51148-ca9d-4a82-a032-afe9fbc9d2e1",
        type: "Feature",
        properties:{
            "-updated-by":"16SV07",
            "creator":"16SV07",
            "-created-on":1752440496159,
            "pattern":"solid",
            "-updated-on":1752440527007,
            "description":"",
            "title":"Proposed route",
            "fill":"#FFAA00",
            "stroke":"#FFAA00",
            "stroke-opacity":1,
            "stroke-width":2,
            "class":"Shape",
            "updated":1752440527007,
            "-created-by": "16SV07"
        },
        geometry: {
            "type":"LineString",
            "coordinates":[[-108.32201957702637,39.129827211090806],[-108.3220018075138,39.12970790405381],[-108.31997,39.12989],[-108.31894,39.12994],[-108.31759,39.13006],[-108.31759,39.13006],[-108.31705,39.13016],[-108.31646,39.13018],[-108.31611,39.13014],[-108.31611,39.13014],[-108.31602,39.13006],[-108.31602,39.13006],[-108.31581,39.12987],[-108.31567,39.12988],[-108.31555,39.13006],[-108.31555,39.13006],[-108.31537,39.13033],[-108.31513,39.13031],[-108.31501,39.1302],[-108.31425,39.13009],[-108.31369,39.13008],[-108.3126,39.1302],[-108.31184,39.13025],[-108.31067,39.13021],[-108.30997,39.13024],[-108.30856,39.13051],[-108.30785,39.13062],[-108.30742,39.13065],[-108.30709,39.13061],[-108.30678,39.13064],[-108.30647,39.13058],[-108.30606,39.13032],[-108.30513,39.13035],[-108.30452,39.13047],[-108.30412,39.13065],[-108.30352,39.13081],[-108.30322,39.13082],[-108.30322,39.13082],[-108.30296,39.13083],[-108.30241,39.1307],[-108.3023773896825,39.13068578524622],[-108.3023753541125,39.13068489796309],[-108.30202,39.13053],[-108.30164,39.13025],[-108.30148,39.13006],[-108.30148,39.13006],[-108.30126,39.12973],[-108.3011,39.12958],[-108.30059,39.12932],[-108.30042,39.1291],[-108.30012,39.12889],[-108.29986,39.12861],[-108.29913,39.12829],[-108.29878,39.1281],[-108.2983,39.1277],[-108.29792,39.12729],[-108.29792,39.12729],[-108.29792,39.12729],[-108.29735,39.12647],[-108.29693,39.12601],[-108.29692064180286,39.12596554856359],[-108.29691933495641,39.12595934116137],[-108.29685,39.12563],[-108.29685844548617,39.12508103606602],[-108.29685844548617,39.12508103606602],[-108.29686,39.12498],[-108.29681,39.12337],[-108.29669,39.12314],[-108.2964,39.12282],[-108.29634,39.12258],[-108.29645,39.12204],[-108.29639,39.1208],[-108.29621,39.12026],[-108.29614,39.11898],[-108.29526,39.1176],[-108.29456857458322,39.11556289715918],[-108.29456669891809,39.11555738111409],[-108.29433,39.11486],[-108.29385,39.11462],[-108.29348,39.11458],[-108.29326,39.11467],[-108.29302,39.11468],[-108.29246834745996,39.11432724225362],[-108.29247,39.11433],[-108.29235,39.11413],[-108.29223,39.11398],[-108.29182,39.11376],[-108.29161,39.11352],[-108.29117,39.11326],[-108.29099,39.11301],[-108.29099,39.11301],[-108.29051,39.11248],[-108.29023,39.11224],[-108.29009,39.11202],[-108.29003,39.11175],[-108.28984,39.11143],[-108.28961,39.11127],[-108.28899,39.11113],[-108.28854,39.1109],[-108.28788,39.11045],[-108.28775,39.11022],[-108.2874,39.11001],[-108.28723,39.10988],[-108.28683,39.10965],[-108.28674,39.10951],[-108.28668,39.10932],[-108.28666,39.1091],[-108.28656,39.10881],[-108.28642,39.10857],[-108.28636,39.10834],[-108.28636,39.10808],[-108.28652,39.10752],[-108.2865,39.10727],[-108.28667,39.10675],[-108.28667,39.10635],[-108.28678,39.10603],[-108.28679,39.1058],[-108.28669,39.10553],[-108.28669,39.10553],[-108.28669,39.10553],[-108.28670575787753,39.105494186641984],[-108.28670799168468,39.105489109868174],[-108.2868,39.10528],[-108.287,39.10414],[-108.28724,39.10366],[-108.2876,39.10311],[-108.28798,39.10279],[-108.28825,39.10268],[-108.28828,39.10242],[-108.28838,39.10196],[-108.28872,39.10176],[-108.28888,39.1015],[-108.28868,39.10102],[-108.28882,39.1003],[-108.28908,39.09978],[-108.28918,39.09924],[-108.28906,39.09813],[-108.28926,39.09747],[-108.28947,39.09702],[-108.28961,39.09623],[-108.28969,39.09596],[-108.28969,39.09596],[-108.28991,39.09517],[-108.28998,39.0946],[-108.28983,39.09421],[-108.28971,39.09371],[-108.28995,39.09331],[-108.28993,39.09291],[-108.28997,39.09237],[-108.28972,39.09133],[-108.28982,39.09065],[-108.28972,39.09008],[-108.29,39.08964],[-108.29003580612097,39.08947290476881]],
        }
    });

    t.ok(feat.properties.start);
    feat.properties.start = '2025-07-14T03:00:57.112Z';
    t.ok(feat.properties.time);
    feat.properties.time = '2025-07-14T03:00:57.112Z';
    t.ok(feat.properties.stale);
    feat.properties.stale = '2025-07-14T03:00:57.112Z';

    t.deepEquals(feat, {
        id:"d9e51148-ca9d-4a82-a032-afe9fbc9d2e1",
        type:"Feature",
        properties:{
            type: 'u-d-f',
            archived: true,
            stroke: "#FFAA00",
            fill: "#FFAA00",
            'stroke-opacity': 1,
            'stroke-width': 2,
            callsign: 'Proposed route',
            remarks: '',
            time: '2025-07-14T03:00:57.112Z',
            start: '2025-07-14T03:00:57.112Z',
            stale: '2025-07-14T03:00:57.112Z',
            center: [ -108.29433, 39.11486 ],
            metadata: {
                "-updated-by":"16SV07",
                "creator":"16SV07",
                "-created-on":1752440496159,
                "pattern":"solid",
                "-updated-on":1752440527007,
                "description":"",
                "title":"Proposed route",
                "fill":"#FFAA00",
                "stroke":"#FFAA00",
                "stroke-opacity":1,
                "stroke-width":2,
                "class":"Shape",
                "updated":1752440527007,
                "-created-by": "16SV07"
            }
        },
        geometry: {
            "type":"LineString",
            "coordinates":[[-108.32201957702637,39.129827211090806],[-108.3220018075138,39.12970790405381],[-108.31997,39.12989],[-108.31894,39.12994],[-108.31759,39.13006],[-108.31759,39.13006],[-108.31705,39.13016],[-108.31646,39.13018],[-108.31611,39.13014],[-108.31611,39.13014],[-108.31602,39.13006],[-108.31602,39.13006],[-108.31581,39.12987],[-108.31567,39.12988],[-108.31555,39.13006],[-108.31555,39.13006],[-108.31537,39.13033],[-108.31513,39.13031],[-108.31501,39.1302],[-108.31425,39.13009],[-108.31369,39.13008],[-108.3126,39.1302],[-108.31184,39.13025],[-108.31067,39.13021],[-108.30997,39.13024],[-108.30856,39.13051],[-108.30785,39.13062],[-108.30742,39.13065],[-108.30709,39.13061],[-108.30678,39.13064],[-108.30647,39.13058],[-108.30606,39.13032],[-108.30513,39.13035],[-108.30452,39.13047],[-108.30412,39.13065],[-108.30352,39.13081],[-108.30322,39.13082],[-108.30322,39.13082],[-108.30296,39.13083],[-108.30241,39.1307],[-108.3023773896825,39.13068578524622],[-108.3023753541125,39.13068489796309],[-108.30202,39.13053],[-108.30164,39.13025],[-108.30148,39.13006],[-108.30148,39.13006],[-108.30126,39.12973],[-108.3011,39.12958],[-108.30059,39.12932],[-108.30042,39.1291],[-108.30012,39.12889],[-108.29986,39.12861],[-108.29913,39.12829],[-108.29878,39.1281],[-108.2983,39.1277],[-108.29792,39.12729],[-108.29792,39.12729],[-108.29792,39.12729],[-108.29735,39.12647],[-108.29693,39.12601],[-108.29692064180286,39.12596554856359],[-108.29691933495641,39.12595934116137],[-108.29685,39.12563],[-108.29685844548617,39.12508103606602],[-108.29685844548617,39.12508103606602],[-108.29686,39.12498],[-108.29681,39.12337],[-108.29669,39.12314],[-108.2964,39.12282],[-108.29634,39.12258],[-108.29645,39.12204],[-108.29639,39.1208],[-108.29621,39.12026],[-108.29614,39.11898],[-108.29526,39.1176],[-108.29456857458322,39.11556289715918],[-108.29456669891809,39.11555738111409],[-108.29433,39.11486],[-108.29385,39.11462],[-108.29348,39.11458],[-108.29326,39.11467],[-108.29302,39.11468],[-108.29246834745996,39.11432724225362],[-108.29247,39.11433],[-108.29235,39.11413],[-108.29223,39.11398],[-108.29182,39.11376],[-108.29161,39.11352],[-108.29117,39.11326],[-108.29099,39.11301],[-108.29099,39.11301],[-108.29051,39.11248],[-108.29023,39.11224],[-108.29009,39.11202],[-108.29003,39.11175],[-108.28984,39.11143],[-108.28961,39.11127],[-108.28899,39.11113],[-108.28854,39.1109],[-108.28788,39.11045],[-108.28775,39.11022],[-108.2874,39.11001],[-108.28723,39.10988],[-108.28683,39.10965],[-108.28674,39.10951],[-108.28668,39.10932],[-108.28666,39.1091],[-108.28656,39.10881],[-108.28642,39.10857],[-108.28636,39.10834],[-108.28636,39.10808],[-108.28652,39.10752],[-108.2865,39.10727],[-108.28667,39.10675],[-108.28667,39.10635],[-108.28678,39.10603],[-108.28679,39.1058],[-108.28669,39.10553],[-108.28669,39.10553],[-108.28669,39.10553],[-108.28670575787753,39.105494186641984],[-108.28670799168468,39.105489109868174],[-108.2868,39.10528],[-108.287,39.10414],[-108.28724,39.10366],[-108.2876,39.10311],[-108.28798,39.10279],[-108.28825,39.10268],[-108.28828,39.10242],[-108.28838,39.10196],[-108.28872,39.10176],[-108.28888,39.1015],[-108.28868,39.10102],[-108.28882,39.1003],[-108.28908,39.09978],[-108.28918,39.09924],[-108.28906,39.09813],[-108.28926,39.09747],[-108.28947,39.09702],[-108.28961,39.09623],[-108.28969,39.09596],[-108.28969,39.09596],[-108.28991,39.09517],[-108.28998,39.0946],[-108.28983,39.09421],[-108.28971,39.09371],[-108.28995,39.09331],[-108.28993,39.09291],[-108.28997,39.09237],[-108.28972,39.09133],[-108.28982,39.09065],[-108.28972,39.09008],[-108.29,39.08964],[-108.29003580612097,39.08947290476881]]
        }
    });

    t.end();
});

test('normalize_geojson - Polygon', async (t) => {
    const feat = await CoTParser.normalize_geojson({
        "id":"6df241c8-a9fa-4a9b-b56c-3fa0cb4af2cb",
        "type":"Feature",
        "properties":{
            "stroke-opacity":1,
            "description":"",
            "stroke-width":2,
            "title":"",
            "fill":"#FF0000",
            "stroke":"#FF0000",
            "fill-opacity": 0.1,
            "class":"Shape",
            "folderId":null
        },
        "geometry":{
            "type":"Polygon",
            "coordinates":[[[-108.52614991983982,39.08398594540733],[-108.52592461428257,39.08398178142443],[-108.5259299787006,39.08389850171485],[-108.5261445554218,39.08389641972085],[-108.52614991983982,39.08398594540733]]]
        }
    });

    t.ok(feat.properties.start);
    feat.properties.start = '2025-07-14T03:00:57.112Z';
    t.ok(feat.properties.time);
    feat.properties.time = '2025-07-14T03:00:57.112Z';
    t.ok(feat.properties.stale);
    feat.properties.stale = '2025-07-14T03:00:57.112Z';

    t.deepEquals(feat, {
        id: "6df241c8-a9fa-4a9b-b56c-3fa0cb4af2cb",
        type:"Feature",
        properties:{
            type: 'u-d-f',
            archived: true,
            stroke: "#FF0000",
            'stroke-opacity': 1,
            'stroke-width': 2,
            fill: "#FF0000",
            'fill-opacity': 0.1,
            callsign: "New Feature",
            remarks: '',
            time: '2025-07-14T03:00:57.112Z',
            start: '2025-07-14T03:00:57.112Z',
            stale: '2025-07-14T03:00:57.112Z',
            center: [ -108.5260372670612, 39.08394118256409 ],
            metadata: {
                "stroke-opacity":1,
                "description":"",
                "stroke-width":2,
                "title":"",
                "fill":"#FF0000",
                "stroke":"#FF0000",
                "fill-opacity": 0.1,
                "class":"Shape",
                "folderId":null
            }
        },
        geometry: {
            "type":"Polygon",
            "coordinates":[[[-108.52614991983982,39.08398594540733],[-108.52592461428257,39.08398178142443],[-108.5259299787006,39.08389850171485],[-108.5261445554218,39.08389641972085],[-108.52614991983982,39.08398594540733]]]
        }
    });

    t.end();
});
